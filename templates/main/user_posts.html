{% extends "base.html" %}

{% block title %}我的博客 - 环球旅记{% endblock %}

{% block styles %}
<style>
    .post-card {
        transition: all 0.3s ease;
        overflow: hidden;
    }
    
    .post-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .post-image {
        height: 220px;
        object-fit: cover;
        transition: transform 0.5s ease;
    }
    
    .post-card:hover .post-image {
        transform: scale(1.05);
    }
    
    .tab-btn {
        color: #64748b;
        font-weight: 500;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    
    .tab-btn:hover {
        background-color: #f1f5f9;
    }
    
    .tab-btn.active {
        color: #3498db;
        background-color: rgba(52, 152, 219, 0.1);
    }
    
    .pagination-link {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        margin: 0 5px;
        border-radius: 50%;
        background-color: #fff;
        color: #333;
        border: 1px solid #eee;
        transition: all 0.3s ease;
    }
    
    .pagination-link:hover, .pagination-link.active {
        background-color: #3498db;
        color: white;
        border-color: #3498db;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 md:px-8 py-8">
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-bold text-gray-800">{% if user %}{{ user.username }} 的博客{% else %}我的博客{% endif %}</h1>
        {% if current_user.is_authenticated and (not user or current_user.id == user.id) %}
        <a href="{{ url_for('main.create_post') }}" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition-all">
            <i class="fas fa-plus mr-2"></i> 发布新故事
        </a>
        {% endif %}
    </div>
    
    <!-- 内容标签页 -->
    <div class="mb-6 border-b border-gray-200">
        <div class="flex flex-wrap">
            {% if user %}
            <a href="{{ url_for('main.user_profile', username=user.username) }}" class="tab-btn {% if request.endpoint == 'main.user_profile' %}active{% endif %}">
                <i class="fas fa-user mr-2"></i> 个人主页
            </a>
            <a href="{{ url_for('main.user_posts', username=user.username) }}" class="tab-btn {% if request.endpoint == 'main.user_posts' %}active{% endif %}">
                <i class="fas fa-pen-nib mr-2"></i> 旅行故事
            </a>
            {% else %}
            <a href="{{ url_for('main.user_profile', username=current_user.username) }}" class="tab-btn {% if request.endpoint == 'main.user_profile' %}active{% endif %}">
                <i class="fas fa-user mr-2"></i> 个人主页
            </a>
            <a href="{{ url_for('main.user_posts') }}" class="tab-btn {% if request.endpoint == 'main.user_posts' %}active{% endif %}">
                <i class="fas fa-pen-nib mr-2"></i> 我的博客
            </a>
            <a href="{{ url_for('main.user_bookmarks') }}" class="tab-btn {% if request.endpoint == 'main.user_bookmarks' %}active{% endif %}">
                <i class="fas fa-bookmark mr-2"></i> 我的收藏
            </a>
            {% endif %}
        </div>
    </div>
    
    <!-- 博客列表 -->
    {% if posts.items %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for post in posts.items %}
        <div class="post-card bg-white rounded-xl overflow-hidden shadow-sm">
            <div class="relative overflow-hidden">
                {% if post.featured_image %}
                <img src="{{ url_for('static', filename='uploads/posts/' + post.featured_image) }}" alt="{{ post.title }}" class="post-image w-full">
                {% else %}
                <img src="{{ url_for('static', filename='img/default-post.jpg') }}" alt="{{ post.title }}" class="post-image w-full">
                {% endif %}
                
                {% if post.location %}
                <div class="absolute bottom-3 left-3 bg-white/80 backdrop-blur-sm text-sm font-medium py-1 px-3 rounded-full">
                    <i class="fas fa-map-marker-alt text-primary mr-1"></i> {{ post.location }}
                </div>
                {% endif %}
            </div>
            
            <div class="p-6">
                <h3 class="text-xl font-bold mb-2 line-clamp-1">{{ post.title }}</h3>
                <p class="text-gray-600 mb-4 line-clamp-2">{{ post.content|striptags }}</p>
                
                <div class="flex justify-between items-center text-sm">
                    <div class="flex items-center space-x-3">
                        <span class="flex items-center text-gray-500">
                            <i class="far fa-calendar-alt mr-1"></i> {{ post.created_at.strftime('%Y-%m-%d') }}
                        </span>
                    </div>
                    
                    <div class="flex items-center space-x-3">
                        <span class="flex items-center text-gray-500">
                            <i class="far fa-eye mr-1"></i> {{ post.views }}
                        </span>
                        <span class="flex items-center text-gray-500">
                            <i class="far fa-comment mr-1"></i> {{ post.comment_count() }}
                        </span>
                    </div>
                </div>
                
                <div class="mt-4 pt-4 border-t border-gray-100 flex justify-between items-center">
                    <a href="{{ url_for('main.post', post_id=post.id) }}" class="text-primary hover:underline font-medium">
                        阅读全文 <i class="fas fa-arrow-right ml-1"></i>
                    </a>
                    
                    {% if current_user.is_authenticated and current_user.id == post.user_id %}
                    <div class="flex space-x-2">
                        <a href="{{ url_for('main.edit_post', post_id=post.id) }}" class="text-gray-500 hover:text-primary">
                            <i class="fas fa-edit"></i>
                        </a>
                        <button type="button" onclick="confirmDeletePost({{ post.id }})" class="text-gray-500 hover:text-red-500">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- 分页 -->
    {% if posts.pages > 1 %}
    <div class="mt-12 flex justify-center">
        <div class="flex flex-wrap items-center">
            {% if posts.has_prev %}
            <a href="{{ url_for('main.user_posts', page=posts.prev_num, username=user.username if user else None) }}" class="pagination-link">
                <i class="fas fa-chevron-left"></i>
            </a>
            {% endif %}
            
            {% for page_num in posts.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                {% if page_num %}
                    {% if posts.page == page_num %}
                    <a href="{{ url_for('main.user_posts', page=page_num, username=user.username if user else None) }}" class="pagination-link active">{{ page_num }}</a>
                    {% else %}
                    <a href="{{ url_for('main.user_posts', page=page_num, username=user.username if user else None) }}" class="pagination-link">{{ page_num }}</a>
                    {% endif %}
                {% else %}
                <span class="px-2">...</span>
                {% endif %}
            {% endfor %}
            
            {% if posts.has_next %}
            <a href="{{ url_for('main.user_posts', page=posts.next_num, username=user.username if user else None) }}" class="pagination-link">
                <i class="fas fa-chevron-right"></i>
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    {% else %}
    <div class="bg-white rounded-lg p-8 text-center shadow-sm">
        <div class="text-5xl text-gray-300 mb-4">
            <i class="far fa-newspaper"></i>
        </div>
        <h3 class="text-xl font-medium text-gray-600 mb-3">暂无博客文章</h3>
        {% if current_user.is_authenticated and (not user or current_user.id == user.id) %}
        <p class="text-gray-500 mb-6">分享您的第一篇旅行故事</p>
        <a href="{{ url_for('main.create_post') }}" class="inline-flex items-center bg-primary hover:bg-primary/90 text-white px-6 py-3 rounded-lg transition-all">
            <i class="fas fa-plus mr-2"></i> 发布新故事
        </a>
        {% else %}
        <p class="text-gray-500">该用户尚未发布任何旅行故事</p>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- 删除确认模态框 -->
{% if current_user.is_authenticated %}
<div id="deletePostModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
        <h3 class="text-xl font-bold mb-4">确认删除</h3>
        <p class="mb-6">您确定要删除这篇文章吗？此操作无法撤销。</p>
        <div class="flex justify-end space-x-3">
            <button id="cancelDeletePost" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100">取消</button>
            <form id="deletePostForm" method="post" action="">
                <button type="submit" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">删除</button>
            </form>
        </div>
    </div>
</div>

<script>
    function confirmDeletePost(postId) {
        const modal = document.getElementById('deletePostModal');
        const form = document.getElementById('deletePostForm');
        const cancelBtn = document.getElementById('cancelDeletePost');
        
        // 设置表单提交地址
        form.action = "{{ url_for('main.delete_post', post_id=0) }}".replace('0', postId);
        
        // 显示模态框
        modal.classList.remove('hidden');
        
        // 关闭模态框
        cancelBtn.addEventListener('click', function() {
            modal.classList.add('hidden');
        });
        
        // 点击遮罩层关闭
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.classList.add('hidden');
            }
        });
    }
</script>
{% endif %}
{% endblock %} 