{% extends 'admin/base.html' %}

{% block title %}旅游博客数据分析 - 管理后台{% endblock %}

{% block head_extra %}
<!-- ECharts 完整版 -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js" defer></script>
<!-- 引入字体图标 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css">
<!-- 浅蓝色主题样式 -->
<style>
:root {
    --primary-color: #165DFF;
    --primary-light: rgba(22, 93, 255, 0.1);
    --primary-dark: #0E42D2;
    --success-color: #00B42A;
    --warning-color: #FF7D00;
    --danger-color: #F53F3F;
    --info-color: #86909C;
    --light-bg: #EBF2FF;
    --light-component: #FFFFFF;
    --light-border: #D9E3F0;
    --text-primary: #1D2129;
    --text-secondary: #4E5969;
    --text-disabled: rgba(0, 0, 0, 0.4);
}

/* 全局样式 */
body {
    background-color: var(--light-bg);
    color: var(--text-primary);
    font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    margin: 0;
    padding: 0;
    min-height: 100vh;
}

.dashboard-container {
    padding: 20px;
    width: 100%;
    box-sizing: border-box;
    max-width: 1920px;
    margin: 0 auto;
}

/* 按钮样式 */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 8px 16px;
    border-radius: 4px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 14px;
    border: none;
}

.btn i {
    margin-right: 6px;
}

.btn-primary {
    background-color: var(--primary-color);
    color: white;
}

.btn-primary:hover {
    background-color: var(--primary-dark);
    box-shadow: 0 4px 12px rgba(22, 93, 255, 0.4);
}

.btn-outline {
    background-color: transparent;
    border: 1px solid var(--light-border);
    color: var(--text-secondary);
}

.btn-outline:hover {
    border-color: var(--primary-color);
    color: var(--primary-color);
}

.btn-action {
    padding: 4px 12px;
    background-color: var(--primary-color);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s ease;
}

.btn-action:hover {
    background-color: var(--primary-dark);
}

.btn-chart-action {
    background: transparent;
    border: 1px solid var(--light-border);
    color: var(--text-secondary);
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s ease;
}

.btn-chart-action.active {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
    color: white;
}

.btn-chart-action:hover:not(.active) {
    color: var(--primary-color);
    border-color: var(--primary-color);
}

.btn-table-action {
    background: transparent;
    border: 1px solid var(--light-border);
    color: var(--text-secondary);
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.2s ease;
}

.btn-table-action:hover {
    color: var(--primary-color);
    border-color: var(--primary-color);
}

/* 顶部控制区域 */
.dashboard-header {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    background-color: var(--light-component);
    border-radius: 8px;
    margin-bottom: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
}

.header-title h1 {
    font-size: 22px;
    margin: 0 0 4px 0;
    color: var(--text-primary);
    font-weight: 600;
}

.subtitle {
    font-size: 14px;
    color: var(--text-secondary);
    margin: 0;
}

.filter-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    align-items: center;
}

.filter-item {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.filter-item label {
    font-size: 12px;
    color: var(--text-secondary);
}

.filter-item select,
.filter-item input {
    background-color: rgba(0, 0, 0, 0.02);
    border: 1px solid var(--light-border);
    border-radius: 4px;
    padding: 8px 12px;
    color: var(--text-primary);
    font-size: 14px;
    min-width: 150px;
}

.filter-item select:focus,
.filter-item input:focus {
    outline: none;
    border-color: var(--primary-color);
}

.date-inputs {
    display: flex;
    align-items: center;
    gap: 8px;
}

.date-inputs span {
    color: var(--text-secondary);
    font-size: 14px;
}

.date-inputs input {
    min-width: auto;
    width: 130px;
}

.filter-actions {
    display: flex;
    gap: 8px;
    margin-left: 16px;
}

/* KPI卡片样式 */
.kpi-section {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
    margin-bottom: 20px;
}

.kpi-card {
    background-color: var(--light-component);
    padding: 20px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.kpi-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.kpi-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
}

.primary-card::before {
    background-color: var(--primary-color);
}

.success-card::before {
    background-color: var(--success-color);
}

.warning-card::before {
    background-color: var(--warning-color);
}

.danger-card::before {
    background-color: var(--danger-color);
}

.kpi-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 16px;
    font-size: 24px;
    flex-shrink: 0;
}

.primary-card .kpi-icon {
    background-color: rgba(22, 93, 255, 0.1);
    color: var(--primary-color);
}

.success-card .kpi-icon {
    background-color: rgba(0, 180, 42, 0.1);
    color: var(--success-color);
}

.warning-card .kpi-icon {
    background-color: rgba(255, 125, 0, 0.1);
    color: var(--warning-color);
}

.danger-card .kpi-icon {
    background-color: rgba(245, 63, 63, 0.1);
    color: var(--danger-color);
}

.kpi-content {
    flex-grow: 1;
}

.kpi-title {
    font-size: 14px;
    color: var(--text-secondary);
    margin: 0 0 6px 0;
    font-weight: normal;
}

.kpi-value {
    font-size: 28px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 8px;
}

.kpi-trend {
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.kpi-trend.up {
    color: var(--success-color);
}

.kpi-trend.down {
    color: var(--danger-color);
}

/* 图表卡片样式 */
.charts-container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-bottom: 20px;
}

.chart-card {
    background-color: var(--light-component);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    height: 100%;
    display: flex;
    flex-direction: column;
}

.wide-card {
    grid-column: span 2;
}

.chart-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--light-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chart-title {
    font-size: 16px;
    font-weight: 500;
    color: var(--text-primary);
    margin: 0;
}

.chart-actions {
    display: flex;
    gap: 8px;
}

.chart-body {
    padding: 20px;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
}

.chart-container {
    width: 100%;
    height: 300px;
    flex-grow: 1;
}

.map-container {
    width: 100%;
    height: 400px;
}

/* 表格样式 */
.tables-container {
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.table-card {
    background-color: var(--light-component);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
}

.table-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--light-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.table-title {
    font-size: 16px;
    font-weight: 500;
    color: var(--text-primary);
    margin: 0;
}

.table-actions {
    display: flex;
    gap: 8px;
}

.table-body {
    padding: 0;
    overflow-x: auto;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th,
.data-table td {
    padding: 12px 16px;
    text-align: left;
    border-bottom: 1px solid var(--light-border);
}

.data-table th {
    font-weight: 500;
    color: var(--text-secondary);
    font-size: 13px;
    background-color: rgba(0, 0, 0, 0.02);
}

.data-table tr:last-child td {
    border-bottom: none;
}

.data-table tbody tr {
    transition: background-color 0.2s ease;
}

.data-table tbody tr:hover {
    background-color: rgba(22, 93, 255, 0.05);
}

/* 进度条 */
.progress-bar {
    width: 100%;
    height: 8px;
    background-color: rgba(0, 0, 0, 0.05);
    border-radius: 4px;
    overflow: hidden;
    position: relative;
}

.progress {
    height: 100%;
    background: linear-gradient(to right, var(--primary-color), var(--primary-dark));
    border-radius: 4px;
}

.progress-bar span {
    position: absolute;
    right: 0;
    top: -18px;
    font-size: 12px;
    color: var(--text-secondary);
}

/* 状态标签 */
.status-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
}

.status-badge.completed {
    background-color: rgba(0, 180, 42, 0.1);
    color: var(--success-color);
}

.status-badge.processing {
    background-color: rgba(255, 125, 0, 0.1);
    color: var(--warning-color);
}

.status-badge.overdue {
    background-color: rgba(245, 63, 63, 0.1);
    color: var(--danger-color);
}

.urgent {
    color: var(--danger-color);
    font-weight: 500;
}

/* 加载动画 */
.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(235, 242, 255, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    backdrop-filter: blur(2px);
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(22, 93, 255, 0.2);
    border-radius: 50%;
    border-top-color: var(--primary-color);
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* 响应式布局 */
@media (max-width: 1200px) {
    .kpi-section {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .charts-container {
        grid-template-columns: 1fr;
    }
    
    .wide-card {
        grid-column: span 1;
    }
}

@media (max-width: 768px) {
    .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .filter-controls {
        width: 100%;
        margin-top: 16px;
    }
    
    .kpi-section {
        grid-template-columns: 1fr;
    }
    
    .filter-item select,
    .filter-item input {
        width: 100%;
    }
    
    .filter-actions {
        margin-top: 16px;
        margin-left: 0;
        width: 100%;
        justify-content: flex-end;
    }
}

/* 动画效果 */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.kpi-card, .chart-card, .table-card {
    animation: fadeIn 0.5s ease forwards;
}

.kpi-card:nth-child(1) { animation-delay: 0.1s; }
.kpi-card:nth-child(2) { animation-delay: 0.2s; }
.kpi-card:nth-child(3) { animation-delay: 0.3s; }
.kpi-card:nth-child(4) { animation-delay: 0.4s; }

/* 滚动条美化 */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: var(--light-bg);
}

::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, 0.1);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: rgba(0, 0, 0, 0.2);
}
</style>
{% endblock %}

{% block content %}
<div id="bureau-dashboard" class="dashboard-container">
    <!-- 顶部控制区域 -->
    <div class="dashboard-header">
        <div class="header-title">
            <h1>旅游博客数据分析</h1>
            <p class="subtitle">旅游内容与用户互动分析平台</p>
        </div>
        <div class="filter-controls">
            <div class="filter-item">
                <label>时间范围</label>
                <select id="time-filter">
                    <option value="today">今日</option>
                    <option value="week">本周</option>
                    <option value="month" selected>本月</option>
                    <option value="quarter">本季度</option>
                    <option value="year">本年度</option>
                    <option value="custom">自定义</option>
                </select>
            </div>
            <div class="filter-item" id="date-range-container" style="display: none;">
                <label>起止日期</label>
                <div class="date-inputs">
                    <input type="date" id="start-date">
                    <span>至</span>
                    <input type="date" id="end-date">
                </div>
            </div>
            <div class="filter-item">
                <label>目的地类型</label>
                <select id="area-filter">
                    <option value="all" selected>全部目的地</option>
                    <option value="beach">海滩度假</option>
                    <option value="mountain">山川自然</option>
                    <option value="city">城市风光</option>
                    <option value="rural">乡村风情</option>
                    <option value="historical">历史文化</option>
                </select>
            </div>
            <div class="filter-item">
                <label>文章分类</label>
                <select id="business-filter">
                    <option value="all" selected>全部分类</option>
                    <option value="guide">旅游攻略</option>
                    <option value="story">旅行故事</option>
                    <option value="food">美食探索</option>
                    <option value="photography">风景摄影</option>
                    <option value="tips">实用贴士</option>
                </select>
            </div>
            <div class="filter-actions">
                <button id="apply-filters" class="btn btn-primary">
                    <i class="fas fa-filter"></i> 应用筛选
                </button>
                <button id="export-data" class="btn btn-outline">
                    <i class="fas fa-download"></i> 导出数据
                </button>
                <button id="refresh-data" class="btn btn-outline">
                    <i class="fas fa-sync-alt"></i> 刷新
                </button>
            </div>
        </div>
    </div>

    <!-- 核心KPI指标卡片 -->
    <div class="kpi-section">
        <div class="kpi-card primary-card">
            <div class="kpi-icon">
                <i class="fas fa-user-friends"></i>
            </div>
            <div class="kpi-content">
                <h3 class="kpi-title">用户总数</h3>
                <div class="kpi-value">{{ user_count }}</div>
                <div class="kpi-trend up">
                    <i class="fas fa-arrow-up"></i> {{ "%.1f"|format(new_users_month_ratio) }}% 较上月
                </div>
            </div>
        </div>
        <div class="kpi-card success-card">
            <div class="kpi-icon">
                <i class="fas fa-file-alt"></i>
            </div>
            <div class="kpi-content">
                <h3 class="kpi-title">博客文章</h3>
                <div class="kpi-value">{{ post_count }}</div>
                <div class="kpi-trend up">
                    <i class="fas fa-arrow-up"></i> {{ post_trend_data.data[-1] / post_trend_data.data[-2] * 100 - 100 if post_trend_data.data[-2] > 0 else 0 |round(1) }}% 较上月
                </div>
            </div>
        </div>
        <div class="kpi-card warning-card">
            <div class="kpi-icon">
                <i class="fas fa-comment-alt"></i>
            </div>
            <div class="kpi-content">
                <h3 class="kpi-title">评论总数</h3>
                <div class="kpi-value">{{ comment_count }}</div>
                <div class="kpi-trend up">
                    <i class="fas fa-arrow-up"></i> {{ (comment_count / (post_count if post_count > 0 else 1) * 10)|round(1) }}% 较上月
                </div>
            </div>
        </div>
        <div class="kpi-card danger-card">
            <div class="kpi-icon">
                <i class="fas fa-eye"></i>
            </div>
            <div class="kpi-content">
                <h3 class="kpi-title">访问量</h3>
                <div class="kpi-value">{{ total_views }}</div>
                <div class="kpi-trend up">
                    <i class="fas fa-arrow-up"></i> {{ (total_views / post_count if post_count > 0 else 0)|round(1) }}% 较上月
                </div>
            </div>
        </div>
    </div>

    <!-- 图表区域 -->
    <div class="charts-container">
        <!-- 趋势分析图表 -->
        <div class="chart-card" id="trend-chart-card">
            <div class="chart-header">
                <h3 class="chart-title">内容发布与互动趋势</h3>
                <div class="chart-actions">
                    <button class="btn-chart-action active" data-type="week">周</button>
                    <button class="btn-chart-action" data-type="month">月</button>
                    <button class="btn-chart-action" data-type="quarter">季</button>
                    <button class="btn-chart-action" data-type="year">年</button>
                </div>
            </div>
            <div class="chart-body">
                <div id="trend-chart" class="chart-container"></div>
            </div>
        </div>

        <!-- 文章分类分布 -->
        <div class="chart-card" id="business-type-card">
            <div class="chart-header">
                <h3 class="chart-title">文章分类分布</h3>
                <div class="chart-actions">
                    <button class="btn-chart-action" id="download-business-chart">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="btn-chart-action" id="fullscreen-business-chart">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>
            <div class="chart-body">
                <div id="business-type-chart" class="chart-container"></div>
            </div>
        </div>

        <!-- 目的地类型分布饼图 -->
        <div class="chart-card" id="destination-type-card">
            <div class="chart-header">
                <h3 class="chart-title">目的地类型分布</h3>
                <div class="chart-actions">
                    <button class="btn-chart-action" id="download-destination-type-chart">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
            </div>
            <div class="chart-body">
                <div id="destination-type-chart" class="chart-container"></div>
            </div>
        </div>

        <!-- 用户活跃度分析 -->
        <div class="chart-card" id="efficiency-card">
            <div class="chart-header">
                <h3 class="chart-title">用户活跃度分析</h3>
                <div class="chart-actions">
                    <button class="btn-chart-action" id="download-efficiency-chart">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
            </div>
            <div class="chart-body">
                <div id="efficiency-chart" class="chart-container"></div>
            </div>
        </div>

        <!-- 用户满意度分析 -->
        <div class="chart-card" id="satisfaction-card">
            <div class="chart-header">
                <h3 class="chart-title">文章评分分析</h3>
                <div class="chart-actions">
                    <button class="btn-chart-action" id="download-satisfaction-chart">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
            </div>
            <div class="chart-body">
                <div id="satisfaction-chart" class="chart-container"></div>
            </div>
        </div>
    </div>

    <!-- 表格数据区域 -->
    <div class="tables-container">
        <!-- 热门文章排行 -->
        <div class="table-card" id="priority-cases-card">
            <div class="table-header">
                <h3 class="table-title">热门文章排行</h3>
                <div class="table-actions">
                    <button class="btn-table-action" id="export-priority-table">
                        <i class="fas fa-download"></i> 导出
                    </button>
                </div>
            </div>
            <div class="table-body">
                <table class="data-table" id="priority-cases-table">
                    <thead>
                        <tr>
                            <th>文章ID</th>
                            <th>文章标题</th>
                            <th>发布日期</th>
                            <th>作者</th>
                            <th>阅读量</th>
                            <th>点赞数</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for post in top_posts %}
                        <tr>
                            <td>{{ post.id }}</td>
                            <td>{{ post.title }}</td>
                            <td>{{ post.created_at.strftime('%Y-%m-%d') }}</td>
                            <td>{{ post.author.username if post.author else '未知' }}</td>
                            <td>{{ post.views }}</td>
                            <td>{{ post.like_count() }}</td>
                            <td><a href="{{ url_for('admin.post_detail', post_id=post.id) }}" class="btn-action">查看</a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 目的地数据统计 -->
        <div class="table-card" id="area-stats-card">
            <div class="table-header">
                <h3 class="table-title">热门目的地统计</h3>
                <div class="table-actions">
                    <button class="btn-table-action" id="export-area-table">
                        <i class="fas fa-download"></i> 导出
                    </button>
                </div>
            </div>
            <div class="table-body">
                <table class="data-table" id="area-stats-table">
                    <thead>
                        <tr>
                            <th>目的地</th>
                            <th>文章数量</th>
                            <th>总阅读量</th>
                            <th>平均评分</th>
                            <th>评论数</th>
                            <th>热度指数</th>
                            <th>增长趋势</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for loc in location_data.labels %}
                        <tr>
                            <td>{{ loc }}</td>
                            <td>{{ location_data.data[loop.index0] }}</td>
                            <td>-</td>
                            <td>-</td>
                            <td>-</td>
                            <td>
                                <div class="progress-bar">
                                    <div class="progress" style="width: {{ (location_data.data[loop.index0] / (location_data.data|max)) * 100 if location_data.data|max else 0 }}%;"></div>
                                    <span>{{ (location_data.data[loop.index0] / (location_data.data|max) * 100) | round(0) if location_data.data|max else 0 }}%</span>
                                </div>
                            </td>
                            <td>-</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript实现 -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 全局配置
    const config = {
        charts: {},
        data: {},
        colors: {
            primary: '#165DFF',
            success: '#00B42A',
            warning: '#FF7D00',
            danger: '#F53F3F',
            info: '#86909C',
            background: '#EBF2FF',
            component: '#FFFFFF'
        },
        animation: {
            enabled: true,
            duration: 1000,
            easing: 'cubicOut'
        }
    };

    // 检查高德地图API是否已加载
    function checkMapApiLoaded() {
        return typeof AMap !== 'undefined';
    }

    // 初始化所有图表
    function initCharts() {
        initTrendChart();
        initBusinessTypeChart();
        initDestinationTypeChart();
        initUserActivityChart();
        initArticleRatingChart();
    }

    // 初始化所有图表并设置事件监听
    initCharts();
    setupEventListeners();

    // 图表初始化
    function initCharts() {
        initTrendChart();
        initBusinessTypeChart();
        initDestinationTypeChart();
        initUserActivityChart();
        initArticleRatingChart();
    }

    // 初始化内容趋势图表
    function initTrendChart() {
        const chartDom = document.getElementById('trend-chart');
        if (!chartDom) return;

        const chart = echarts.init(chartDom);
        config.charts.trend = chart;

        // 旅游博客数据
        const data = {
            week: {
                xAxis: ['周一', '周二', '周三', '周四', '周五', '周六', '周日'],
                series: [
                    {name: '发布文章', data: [5, 8, 6, 9, 10, 12, 15]},
                    {name: '评论数', data: [25, 32, 28, 38, 42, 58, 85]},
                    {name: '访问量', data: [120, 132, 101, 134, 190, 230, 310]}
                ]
            },
            month: {
                xAxis: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
                series: [
                    {name: '发布文章', data: [42, 38, 45, 48, 52, 62, 68, 75, 58, 52, 48, 55]},
                    {name: '评论数', data: [185, 178, 192, 213, 242, 285, 302, 328, 275, 246, 228, 265]},
                    {name: '访问量', data: [980, 920, 1050, 1200, 1350, 1680, 1820, 1950, 1680, 1450, 1320, 1580]}
                ]
            }
        };

        // 缓存数据
        config.data.trend = data;

        // 默认显示月数据
        const option = createTrendChartOption(data.month);
        chart.setOption(option);

        // 响应窗口大小调整
        window.addEventListener('resize', function() {
            chart.resize();
        });
    }

    // 创建趋势图表配置
    function createTrendChartOption(data) {
        return {
            backgroundColor: 'transparent',
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'shadow'
                }
            },
            legend: {
                data: ['发布文章', '评论数', '访问量'],
                right: 10,
                top: 0,
                textStyle: {
                    color: 'rgba(0, 0, 0, 0.7)'
                },
                icon: 'roundRect'
            },
            grid: {
                left: '3%',
                right: '4%',
                bottom: '3%',
                top: '40px',
                containLabel: true
            },
            xAxis: {
                type: 'category',
                data: data.xAxis,
                axisLine: {
                    lineStyle: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                },
                axisLabel: {
                    color: 'rgba(0, 0, 0, 0.7)'
                }
            },
            yAxis: {
                type: 'value',
                splitLine: {
                    lineStyle: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                axisLabel: {
                    color: 'rgba(0, 0, 0, 0.7)'
                }
            },
            series: [
                {
                    name: '发布文章',
                    type: 'bar',
                    data: data.series[0].data,
                    itemStyle: {
                        color: config.colors.primary
                    },
                    emphasis: {
                        focus: 'series'
                    },
                    barWidth: '20%',
                    barGap: '10%'
                },
                {
                    name: '评论数',
                    type: 'bar',
                    data: data.series[1].data,
                    itemStyle: {
                        color: config.colors.warning
                    },
                    emphasis: {
                        focus: 'series'
                    },
                    barWidth: '20%'
                },
                {
                    name: '访问量',
                    type: 'line',
                    data: data.series[2].data,
                    itemStyle: {
                        color: config.colors.success
                    },
                    emphasis: {
                        focus: 'series'
                    },
                    smooth: true,
                    symbolSize: 6,
                    lineStyle: {
                        width: 3
                    }
                }
            ],
            animationDuration: config.animation.duration,
            animationEasing: config.animation.easing
        };
    }

    // 初始化文章分类图表
    function initBusinessTypeChart() {
        const chartDom = document.getElementById('business-type-chart');
        if (!chartDom) return;

        const chart = echarts.init(chartDom);
        config.charts.businessType = chart;

        // 旅游博客文章分类数据
        const data = JSON.parse('{{ category_data|tojson|safe }}');

        const option = {
            backgroundColor: 'transparent',
            tooltip: {
                trigger: 'item',
                formatter: '{a} <br/>{b}: {c} ({d}%)'
            },
            legend: {
                orient: 'vertical',
                right: 10,
                top: 'center',
                textStyle: {
                    color: 'rgba(0, 0, 0, 0.7)'
                },
                formatter: function(name) {
                    let total = 0;
                    let target;
                    for (let i = 0; i < data.length; i++) {
                        total += data[i].value;
                        if (data[i].name === name) {
                            target = data[i].value;
                        }
                    }
                    const percentage = ((target / total) * 100).toFixed(1);
                    return name + ' ' + percentage + '%';
                }
            },
            series: [
                {
                    name: '文章分类',
                    type: 'pie',
                    radius: ['45%', '70%'],
                    center: ['35%', '60%'],
                    avoidLabelOverlap: false,
                    itemStyle: {
                        borderColor: config.colors.component,
                        borderWidth: 2
                    },
                    label: {
                        show: false
                    },
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: 14,
                            fontWeight: 'bold'
                        }
                    },
                    labelLine: {
                        show: false
                    },
                    data: data,
                    color: ['#165DFF', '#00B42A', '#FF7D00', '#F53F3F', '#86909C']
                }
            ],
            animationDuration: config.animation.duration,
            animationEasing: config.animation.easing
        };

        chart.setOption(option);

        // 响应窗口大小调整
        window.addEventListener('resize', function() {
            chart.resize();
        });
    }

    // 初始化用户活跃度图表
    function initUserActivityChart() {
        const chartDom = document.getElementById('efficiency-chart');
        if (!chartDom) return;

        const chart = echarts.init(chartDom);
        config.charts.userActivity = chart;

        // 用户活跃度数据
        const data = JSON.parse('{{ user_activity_stats|tojson|safe }}');

        const option = {
            backgroundColor: 'transparent',
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'shadow'
                }
            },
            grid: {
                left: '3%',
                right: '4%',
                bottom: '3%',
                top: '3%',
                containLabel: true
            },
            yAxis: {
                type: 'category',
                data: data.map(item => item.name),
                axisLine: {
                    lineStyle: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                },
                axisLabel: {
                    color: 'rgba(0, 0, 0, 0.7)'
                }
            },
            xAxis: {
                type: 'value',
                axisLabel: {
                    formatter: '{value}%',
                    color: 'rgba(0, 0, 0, 0.7)'
                },
                axisLine: {
                    lineStyle: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                },
                splitLine: {
                    lineStyle: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            },
            series: [
                {
                    name: '用户比例',
                    type: 'bar',
                    data: data.map(item => item.value),
                    barWidth: '60%',
                    itemStyle: {
                        color: function(params) {
                            // 根据值设置不同的颜色
                            const colors = ['#00B42A', '#165DFF', '#86909C', '#FF7D00', '#F53F3F'];
                            return colors[params.dataIndex];
                        },
                        borderRadius: [0, 4, 4, 0]
                    },
                    label: {
                        show: true,
                        position: 'right',
                        formatter: '{c}%',
                        color: 'rgba(0, 0, 0, 0.7)'
                    }
                }
            ],
            animationDuration: config.animation.duration,
            animationEasing: config.animation.easing
        };

        chart.setOption(option);

        // 响应窗口大小调整
        window.addEventListener('resize', function() {
            chart.resize();
        });
    }

    // 初始化文章评分分析图表
    function initArticleRatingChart() {
        const chartDom = document.getElementById('satisfaction-chart');
        if (!chartDom) return;

        const chart = echarts.init(chartDom);
        config.charts.articleRating = chart;

        // 文章评分数据
        const data = JSON.parse('{{ rating_stats|tojson|safe }}');

        // 计算平均评分
        const totalScore = data.reduce((sum, item, index) => sum + item.value * (5 - index), 0);
        const totalRatings = data.reduce((sum, item) => sum + item.value, 0);
        const averageRating = (totalScore / totalRatings).toFixed(1);

        const option = {
            backgroundColor: 'transparent',
            title: {
                text: `平均评分 ${averageRating}`,
                left: 'center',
                top: 'center',
                textStyle: {
                    color: '#1D2129',
                    fontSize: 16,
                    fontWeight: 'normal'
                },
                subtextStyle: {
                    color: 'rgba(0, 0, 0, 0.7)',
                    fontSize: 14
                }
            },
            tooltip: {
                trigger: 'item',
                formatter: '{a} <br/>{b}: {c} ({d}%)'
            },
            legend: {
                orient: 'vertical',
                right: 10,
                top: 'center',
                textStyle: {
                    color: 'rgba(0, 0, 0, 0.7)'
                }
            },
            series: [
                {
                    name: '评分分布',
                    type: 'pie',
                    radius: ['50%', '70%'],
                    avoidLabelOverlap: false,
                    itemStyle: {
                        borderColor: config.colors.component,
                        borderWidth: 2,
                        borderRadius: 4
                    },
                    label: {
                        show: false
                    },
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: 14,
                            fontWeight: 'bold'
                        }
                    },
                    labelLine: {
                        show: false
                    },
                    data: data,
                    color: [
                        config.colors.success, 
                        config.colors.primary, 
                        config.colors.info, 
                        config.colors.warning, 
                        config.colors.danger
                    ]
                }
            ],
            animationDuration: config.animation.duration,
            animationEasing: config.animation.easing
        };

        chart.setOption(option);

        // 响应窗口大小调整
        window.addEventListener('resize', function() {
            chart.resize();
        });
    }

    // 初始化目的地类型分布饼图
    function initDestinationTypeChart() {
        const chartDom = document.getElementById('destination-type-chart');
        if (!chartDom) return;
        const chart = echarts.init(chartDom);
        config.charts.destinationType = chart;
        // 使用后端传递的真实数据
        const data = JSON.parse('{{ destination_type_data|tojson|safe }}');
        const option = {
            tooltip: { trigger: 'item' },
            legend: { top: '5%', left: 'center' },
            series: [
                {
                    name: '目的地类型',
                    type: 'pie',
                    radius: ['40%', '70%'],
                    center: ['50%', '60%'],
                    avoidLabelOverlap: false,
                    itemStyle: { borderRadius: 10, borderColor: '#fff', borderWidth: 2 },
                    label: { show: false, position: 'center' },
                    emphasis: { label: { show: true, fontSize: 18, fontWeight: 'bold' } },
                    labelLine: { show: false },
                    data: data
                }
            ]
        };
        chart.setOption(option);
    }

    // 事件监听设置
    function setupEventListeners() {
        // 时间范围下拉框变化事件
        const timeFilter = document.getElementById('time-filter');
        if (timeFilter) {
            timeFilter.addEventListener('change', function() {
                const selectedValue = this.value;
                const dateRangeContainer = document.getElementById('date-range-container');
                
                if (selectedValue === 'custom') {
                    dateRangeContainer.style.display = 'block';
                } else {
                    dateRangeContainer.style.display = 'none';
                    
                    // 更新图表数据
                    if (selectedValue === 'week' || selectedValue === 'month') {
                        updateTrendChart(selectedValue);
                    }
                    
                    // 自动应用筛选
                    autoApplyFilters();
                }
            });
        }
        
        // 目的地类型下拉框变化事件
        const areaFilter = document.getElementById('area-filter');
        if (areaFilter) {
            areaFilter.addEventListener('change', function() {
                // 自动应用筛选
                autoApplyFilters();
            });
        }
        
        // 文章分类下拉框变化事件
        const businessFilter = document.getElementById('business-filter');
        if (businessFilter) {
            businessFilter.addEventListener('change', function() {
                // 自动应用筛选
                autoApplyFilters();
            });
        }
        
        // 自定义日期范围输入框变化事件
        const startDate = document.getElementById('start-date');
        const endDate = document.getElementById('end-date');
        
        if (startDate && endDate) {
            startDate.addEventListener('change', function() {
                if (endDate.value) {
                    autoApplyFilters();
                }
            });
            
            endDate.addEventListener('change', function() {
                if (startDate.value) {
                    autoApplyFilters();
                }
            });
        }
        
        // 趋势图表周期切换按钮
        const trendChartBtns = document.querySelectorAll('#trend-chart-card .btn-chart-action');
        trendChartBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                // 移除所有按钮的active类
                trendChartBtns.forEach(b => b.classList.remove('active'));
                // 给当前按钮添加active类
                this.classList.add('active');
                
                // 获取周期类型并更新图表
                const type = this.getAttribute('data-type');
                updateTrendChart(type);
            });
        });
        
        // 地图视图切换按钮
        const mapViewBtns = document.querySelectorAll('#map-card .btn-chart-action[data-view]');
        mapViewBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                // 移除所有按钮的active类
                mapViewBtns.forEach(b => b.classList.remove('active'));
                // 给当前按钮添加active类
                this.classList.add('active');
                
                // 获取视图类型并切换地图显示
                const viewType = this.getAttribute('data-view');
                toggleMapView(viewType);
            });
        });
        
        // 筛选按钮点击事件
        const applyFiltersBtn = document.getElementById('apply-filters');
        if (applyFiltersBtn) {
            applyFiltersBtn.addEventListener('click', function() {
                // 收集筛选条件并应用
                autoApplyFilters();
                
                // 显示应用成功提示
                showToast('筛选条件已应用');
            });
        }
        
        // 刷新按钮点击事件
        const refreshBtn = document.getElementById('refresh-data');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', function() {
                // 显示刷新中状态
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 刷新中';
                this.disabled = true;
                
                // 模拟刷新延迟
                setTimeout(() => {
                    // 刷新所有图表
                    refreshAllCharts();
                    
                    // 恢复按钮状态
                    this.innerHTML = '<i class="fas fa-sync-alt"></i> 刷新';
                    this.disabled = false;
                    
                    // 显示刷新成功提示
                    showToast('数据已更新');
                }, 1000);
            });
        }
        
        // 导出按钮点击事件
        const exportBtn = document.getElementById('export-data');
        if (exportBtn) {
            exportBtn.addEventListener('click', function() {
                // 显示导出选项弹窗(简化版)
                showToast('数据导出功能即将上线');
            });
        }
    }

    // 自动应用筛选条件
    function autoApplyFilters() {
        // 添加加载动画
        const chartCards = document.querySelectorAll('.chart-card');
        chartCards.forEach(card => {
            const chartBody = card.querySelector('.chart-body');
            const existingOverlay = chartBody.querySelector('.loading-overlay');
            
            if (!existingOverlay) {
                const overlay = document.createElement('div');
                overlay.className = 'loading-overlay';
                overlay.innerHTML = '<div class="loading-spinner"></div>';
                chartBody.appendChild(overlay);
            }
        });
        
        // 收集筛选条件
        const timeRange = document.getElementById('time-filter').value;
        const destinationType = document.getElementById('area-filter').value;
        const articleCategory = document.getElementById('business-filter').value;
        
        // 自定义日期处理
        let customDateRange = null;
        if (timeRange === 'custom') {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            if (startDate && endDate) {
                customDateRange = {
                    start: startDate,
                    end: endDate
                };
            }
        }
        
        // 应用筛选条件
        applyFilters(timeRange, destinationType, articleCategory, customDateRange);
        
        // 短暂延迟后移除加载动画（模拟API请求时间）
        setTimeout(() => {
            chartCards.forEach(card => {
                const overlay = card.querySelector('.loading-overlay');
                if (overlay) {
                    overlay.style.opacity = '0';
                    setTimeout(() => overlay.remove(), 300);
                }
            });
        }, 800);
    }

    // 应用筛选条件
    function applyFilters(timeRange, destinationType, articleCategory, customDateRange = null) {
        // 这里仅为演示，实际项目中应该根据筛选条件从后端获取数据
        console.log('应用筛选:', {timeRange, destinationType, articleCategory, customDateRange});
        
        // 根据筛选条件调整波动范围
        let fluctuationRange = 0.3; // 默认波动
        
        // 如果是目的地筛选，对地图数据有更大影响
        if (destinationType !== 'all') {
            // 如果选择了特定目的地类型，模拟对地图数据的更大影响
            updateMapByDestinationType(destinationType);
        }
        
        // 如果是文章分类筛选，对分类饼图有更大影响
        if (articleCategory !== 'all') {
            // 如果选择了特定文章分类，模拟对分类数据的更大影响
            updateCategoryChartByType(articleCategory);
        } else {
            // 默认情况，随机刷新所有图表
            refreshAllCharts(true);
        }
    }
    
    // 根据目的地类型更新地图
    function updateMapByDestinationType(destinationType) {
        const map = config.charts.map;
        const heatmap = config.heatmap;
        const markerLayer = config.markerLayer;
        
        if (!map || !heatmap) return;
        
        // 获取特定类型的热门目的地
        let destinations = [];
        
        switch(destinationType) {
            case 'beach':
                destinations = [
                    {name: '三亚', position: [109.508268, 18.247872], count: 145},
                    {name: '青岛', position: [120.383428, 36.105215], count: 85},
                    {name: '厦门', position: [118.089425, 24.479834], count: 90},
                    {name: '北海', position: [109.119927, 21.481254], count: 65},
                    {name: '大连', position: [121.614682, 38.914003], count: 55}
                ];
                break;
            case 'mountain':
                destinations = [
                    {name: '丽江', position: [100.233026, 26.872108], count: 134},
                    {name: '黄山', position: [118.337481, 29.714429], count: 78},
                    {name: '张家界', position: [110.479921, 29.127401], count: 88},
                    {name: '九寨沟', position: [103.946205, 33.252101], count: 72},
                    {name: '泰山', position: [117.089319, 36.269831], count: 68}
                ];
                break;
            case 'city':
                destinations = [
                    {name: '北京', position: [116.397428, 39.90923], count: 165},
                    {name: '上海', position: [121.473701, 31.230416], count: 142},
                    {name: '广州', position: [113.264385, 23.129112], count: 123},
                    {name: '深圳', position: [114.085947, 22.547], count: 115},
                    {name: '成都', position: [104.065735, 30.659462], count: 120},
                    {name: '杭州', position: [120.15507, 30.274085], count: 118}
                ];
                break;
            case 'rural':
                destinations = [
                    {name: '婺源', position: [117.861744, 29.251251], count: 62},
                    {name: '凤凰古城', position: [109.598959, 27.942719], count: 75},
                    {name: '阳朔', position: [110.494699, 24.77832], count: 58},
                    {name: '大理古城', position: [100.166096, 25.691636], count: 83},
                    {name: '乌镇', position: [120.484539, 30.746311], count: 69}
                ];
                break;
            case 'historical':
                destinations = [
                    {name: '西安', position: [108.93977, 34.341574], count: 102},
                    {name: '北京', position: [116.397428, 39.90923], count: 98},
                    {name: '南京', position: [118.796877, 32.060255], count: 79},
                    {name: '洛阳', position: [112.454235, 34.619682], count: 65},
                    {name: '苏州', position: [120.585315, 31.298886], count: 85}
                ];
                break;
            default:
                // 使用所有目的地数据
                destinations = [
                    {name: '北京', position: [116.397428, 39.90923], count: 165},
                    {name: '上海', position: [121.473701, 31.230416], count: 142},
                    {name: '广州', position: [113.264385, 23.129112], count: 123},
                    {name: '深圳', position: [114.085947, 22.547], count: 115},
                    {name: '三亚', position: [109.508268, 18.247872], count: 145},
                    {name: '丽江', position: [100.233026, 26.872108], count: 134},
                    {name: '西安', position: [108.93977, 34.341574], count: 102},
                    {name: '成都', position: [104.065735, 30.659462], count: 120},
                    {name: '大理', position: [100.225668, 25.589449], count: 95},
                    {name: '杭州', position: [120.15507, 30.274085], count: 118},
                    {name: '厦门', position: [118.089425, 24.479834], count: 90},
                    {name: '青岛', position: [120.383428, 36.105215], count: 85},
                    {name: '香港', position: [114.173355, 22.320048], count: 80},
                    {name: '拉萨', position: [91.117212, 29.646923], count: 75},
                    {name: '桂林', position: [110.28639, 25.262901], count: 70}
                ];
        }
        
        // 创建热力图数据
        const heatmapData = destinations.map(item => {
            return {
                lng: item.position[0],
                lat: item.position[1],
                count: item.count
            };
        });
        
        // 更新热力图数据
        heatmap.setDataSet({
            data: heatmapData,
            max: 150  // 权重最大值
        });
        
        // 更新其他图表
        refreshOtherCharts();
    }
    
    // 根据文章分类更新饼图
    function updateCategoryChartByType(categoryType) {
        const chart = config.charts.businessType;
        if (!chart) return;
        
        let data = [];
        
        // 根据分类调整数据
        switch(categoryType) {
            case 'guide':
                data = [
                    {value: 425, name: '旅游攻略'},
                    {value: Math.round(Math.random() * 50 + 20), name: '旅行故事'},
                    {value: Math.round(Math.random() * 30 + 10), name: '美食探索'},
                    {value: Math.round(Math.random() * 20 + 10), name: '风景摄影'},
                    {value: Math.round(Math.random() * 20 + 5), name: '实用贴士'}
                ];
                break;
            case 'story':
                data = [
                    {value: Math.round(Math.random() * 50 + 20), name: '旅游攻略'},
                    {value: 318, name: '旅行故事'},
                    {value: Math.round(Math.random() * 30 + 10), name: '美食探索'},
                    {value: Math.round(Math.random() * 20 + 10), name: '风景摄影'},
                    {value: Math.round(Math.random() * 20 + 5), name: '实用贴士'}
                ];
                break;
            case 'food':
                data = [
                    {value: Math.round(Math.random() * 50 + 20), name: '旅游攻略'},
                    {value: Math.round(Math.random() * 40 + 30), name: '旅行故事'},
                    {value: 265, name: '美食探索'},
                    {value: Math.round(Math.random() * 20 + 10), name: '风景摄影'},
                    {value: Math.round(Math.random() * 20 + 5), name: '实用贴士'}
                ];
                break;
            case 'photography':
                data = [
                    {value: Math.round(Math.random() * 50 + 20), name: '旅游攻略'},
                    {value: Math.round(Math.random() * 40 + 30), name: '旅行故事'},
                    {value: Math.round(Math.random() * 30 + 10), name: '美食探索'},
                    {value: 212, name: '风景摄影'},
                    {value: Math.round(Math.random() * 20 + 5), name: '实用贴士'}
                ];
                break;
            case 'tips':
                data = [
                    {value: Math.round(Math.random() * 50 + 20), name: '旅游攻略'},
                    {value: Math.round(Math.random() * 40 + 30), name: '旅行故事'},
                    {value: Math.round(Math.random() * 30 + 10), name: '美食探索'},
                    {value: Math.round(Math.random() * 20 + 10), name: '风景摄影'},
                    {value: 147, name: '实用贴士'}
                ];
                break;
            default:
                data = [
                    {value: 425, name: '旅游攻略'},
                    {value: 318, name: '旅行故事'},
                    {value: 265, name: '美食探索'},
                    {value: 212, name: '风景摄影'},
                    {value: 147, name: '实用贴士'}
                ];
        }
        
        // 更新饼图数据
        const option = chart.getOption();
        option.series[0].data = data;
        chart.setOption(option);
        
        // 更新其他图表
        refreshOtherCharts();
    }
    
    // 刷新除了已特别处理的图表外的其他图表
    function refreshOtherCharts() {
        // 更新趋势图表
        if (config.charts.trend) {
            const trendChart = config.charts.trend;
            const option = trendChart.getOption();
            
            option.series.forEach(series => {
                if (Array.isArray(series.data)) {
                    series.data = series.data.map(value => {
                        // 在原数据基础上增加或减少随机波动
                        const factor = 0.8 + Math.random() * 0.4; // 0.8-1.2的波动
                        return Math.max(0, Math.round(value * factor));
                    });
                }
            });
            
            trendChart.setOption(option);
        }
        
        // 更新用户活跃度图表
        if (config.charts.userActivity) {
            const activityChart = config.charts.userActivity;
            const option = activityChart.getOption();
            
            if (Array.isArray(option.series[0].data)) {
                option.series[0].data = option.series[0].data.map(value => {
                    // 在原数据基础上增加或减少随机波动
                    const factor = 0.9 + Math.random() * 0.2; // 0.9-1.1的波动
                    return Math.max(0, Math.round(value * factor));
                });
            }
            
            activityChart.setOption(option);
        }
        
        // 更新文章评分图表
        if (config.charts.articleRating) {
            const ratingChart = config.charts.articleRating;
            const option = ratingChart.getOption();
            
            if (Array.isArray(option.series[0].data)) {
                option.series[0].data.forEach(item => {
                    // 在原数据基础上增加或减少随机波动
                    const factor = 0.95 + Math.random() * 0.1; // 0.95-1.05的波动
                    item.value = Math.max(1, Math.round(item.value * factor));
                });
                
                // 重新计算平均评分
                const data = option.series[0].data;
                const totalScore = data.reduce((sum, item, index) => sum + item.value * (5 - index), 0);
                const totalRatings = data.reduce((sum, item) => sum + item.value, 0);
                const averageRating = (totalScore / totalRatings).toFixed(1);
                
                option.title.text = `平均评分 ${averageRating}`;
            }
            
            ratingChart.setOption(option);
        }
        
        // 更新表格数据
        updateTableData();
    }
    
    // 更新表格数据
    function updateTableData() {
        // 更新热门文章排行表格
        const popularTable = document.getElementById('priority-cases-table');
        if (popularTable) {
            const rows = popularTable.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const viewsCell = row.cells[4];
                const likesCell = row.cells[5];
                
                if (viewsCell && likesCell) {
                    // 解析当前值
                    const currentViews = parseInt(viewsCell.textContent.replace(/,/g, ''));
                    const currentLikes = parseInt(likesCell.textContent.replace(/,/g, ''));
                    
                    // 添加随机波动
                    const newViews = Math.round(currentViews * (0.95 + Math.random() * 0.1));
                    const newLikes = Math.round(currentLikes * (0.97 + Math.random() * 0.06));
                    
                    // 格式化数字并更新单元格
                    viewsCell.textContent = newViews.toLocaleString();
                    likesCell.textContent = newLikes.toLocaleString();
                }
            });
        }
        
        // 更新热门目的地统计表格
        const destTable = document.getElementById('area-stats-table');
        if (destTable) {
            const rows = destTable.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const readCell = row.cells[2];
                const commentCell = row.cells[4];
                const progressBar = row.querySelector('.progress');
                const progressSpan = row.querySelector('.progress-bar span');
                
                if (readCell && commentCell && progressBar && progressSpan) {
                    // 解析当前值
                    const currentReads = parseInt(readCell.textContent.replace(/,/g, ''));
                    const currentComments = parseInt(commentCell.textContent.replace(/,/g, ''));
                    
                    // 添加随机波动
                    const newReads = Math.round(currentReads * (0.97 + Math.random() * 0.06));
                    const newComments = Math.round(currentComments * (0.95 + Math.random() * 0.1));
                    
                    // 更新进度条
                    const currentProgress = parseInt(progressSpan.textContent);
                    let newProgress = currentProgress + Math.round((Math.random() - 0.5) * 6); // -3到+3的变化
                    newProgress = Math.max(50, Math.min(98, newProgress)); // 保持在50-98%范围内
                    
                    // 格式化数字并更新单元格
                    readCell.textContent = newReads.toLocaleString();
                    commentCell.textContent = newComments.toLocaleString();
                    progressBar.style.width = `${newProgress}%`;
                    progressSpan.textContent = `${newProgress}%`;
                }
            });
        }
    }

    // 更新趋势图表
    function updateTrendChart(type) {
        const chart = config.charts.trend;
        if (!chart) return;
        
        // 获取对应周期的数据
        const data = config.data.trend[type];
        if (!data) return;
        
        // 更新图表配置
        const option = createTrendChartOption(data);
        chart.setOption(option);
    }

    // 刷新所有图表
    function refreshAllCharts(isFilter = false) {
        // 根据不同的刷新来源，设置不同的随机波动范围
        const fluctuationRange = isFilter ? 0.5 : 0.2; // 筛选时波动更大
        
        // 遍历charts对象中的所有图表实例并更新
        Object.keys(config.charts).forEach(key => {
            const chart = config.charts[key];
            if (chart && chart.getOption) {
                // 随机更新数据点(仅做演示)
                const option = chart.getOption();
                
                // 根据图表类型处理
                if (option.series[0].type === 'bar' || option.series[0].type === 'line') {
                    option.series.forEach(series => {
                        if (Array.isArray(series.data)) {
                            series.data = series.data.map(value => {
                                // 在原数据基础上增加或减少随机波动
                                const factor = 1 - fluctuationRange + Math.random() * fluctuationRange * 2;
                                return Math.max(0, Math.round(value * factor));
                            });
                        }
                    });
                } else if (option.series[0].type === 'pie') {
                    option.series[0].data.forEach(item => {
                        // 在原数据基础上增加或减少随机波动
                        const factor = 1 - fluctuationRange + Math.random() * fluctuationRange * 2;
                        item.value = Math.max(1, Math.round(item.value * factor));
                    });
                    
                    // 如果是评分图表，重新计算平均评分
                    if (key === 'articleRating') {
                        const data = option.series[0].data;
                        const totalScore = data.reduce((sum, item, index) => sum + item.value * (5 - index), 0);
                        const totalRatings = data.reduce((sum, item) => sum + item.value, 0);
                        const averageRating = (totalScore / totalRatings).toFixed(1);
                        
                        option.title.text = `平均评分 ${averageRating}`;
                    }
                }
                
                chart.setOption(option);
            }
        });
        
        // 更新表格数据
        updateTableData();
    }

    // 切换地图视图 (热力图/标记点)
    function toggleMapView(viewType) {
        if (!config.heatmap || !config.markerLayer) return;
        
        if (viewType === 'heat') {
            // 显示热力图，隐藏标记点
            config.heatmap.show();
            config.markerLayer.hide();
        } else if (viewType === 'marker') {
            // 隐藏热力图，显示标记点
            config.heatmap.hide();
            config.markerLayer.show();
        }
    }

    // 显示Toast提示
    function showToast(message) {
        // 移除已存在的toast
        const existingToast = document.querySelector('.toast-message');
        if (existingToast) {
            existingToast.remove();
        }
        
        // 创建新的toast元素
        const toast = document.createElement('div');
        toast.className = 'toast-message';
        toast.textContent = message;
        
        // 添加样式
        toast.style.position = 'fixed';
        toast.style.top = '20px';
        toast.style.right = '20px';
        toast.style.background = 'rgba(22, 93, 255, 0.9)';
        toast.style.color = '#FFFFFF';
        toast.style.padding = '10px 20px';
        toast.style.borderRadius = '4px';
        toast.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
        toast.style.zIndex = '9999';
        toast.style.transition = 'opacity 0.3s ease';
        
        // 添加到body
        document.body.appendChild(toast);
        
        // 3秒后自动消失
        setTimeout(() => {
            toast.style.opacity = '0';
            
            // 动画完成后移除元素
            setTimeout(() => {
                toast.remove();
            }, 300);
        }, 3000);
    }

    // 表格导出功能预留
    document.getElementById('export-priority-table').onclick = function() {
        window.location.href = '/admin/export/top_posts';
    };
    document.getElementById('export-area-table').onclick = function() {
        window.location.href = '/admin/export/location_stats';
    };
});
</script>
{% endblock %} 