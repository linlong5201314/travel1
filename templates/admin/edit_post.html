{% extends "admin/base.html" %}

{% block title %}编辑帖子 - 环球旅记{% endblock %}

{% block head %}
{{ super() }}
<!-- 引入UEditor相关资源 -->
<script type="text/javascript" src="{{ url_for('static', filename='ueditor/ueditor.config.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='ueditor/ueditor.all.min.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='ueditor/lang/zh-cn/zh-cn.js') }}"></script>
{% endblock %}

{% block styles %}
<style>
    /* 卡片样式 */
    .edit-card {
        background-color: #ffffff;
        border-radius: 16px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        padding: 30px;
        margin-bottom: 20px;
    }
    
    /* 表单样式 */
    label {
        display: block;
        margin-bottom: 10px;
        font-weight: 600;
        color: #384052;
    }
    
    .form-input {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #dbe0ea;
        border-radius: 8px;
        font-size: 16px;
        transition: all 0.2s;
        margin-bottom: 20px;
    }
    
    .form-input:focus {
        border-color: #4a90e2;
        box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.25);
        outline: none;
    }
    
    /* 按钮样式 */
    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #2b7bff 0%, #135cc5 100%);
        color: white;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(43, 123, 255, 0.3);
    }
    
    .btn-secondary {
        background: #f0f4f9;
        color: #384052;
    }
    
    .btn-secondary:hover {
        background: #dbe0ea;
    }
    
    /* 复选框样式 */
    .checkbox-container {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .checkbox-container input[type="checkbox"] {
        margin-right: 10px;
        width: 18px;
        height: 18px;
    }
    
    /* 编辑器样式 */
    #editor {
        min-height: 400px;
        margin-bottom: 20px;
    }
    
    /* 临时编辑器样式 */
    .temp-editor {
        width: 100%;
        min-height: 400px;
        padding: 12px 16px;
        border: 1px solid #dbe0ea;
        border-radius: 8px;
        font-size: 16px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-10">
    <div class="max-w-5xl mx-auto">
        <h1 class="text-3xl font-bold text-blue-800 mb-8">编辑帖子</h1>
        
        <div class="edit-card">
            <form method="POST" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="mb-6">
                    <label for="title">标题</label>
                    <input type="text" id="title" name="title" class="form-input" value="{{ post.title }}" required>
                </div>
                
                <div class="mb-6">
                    <label for="location">地点</label>
                    <input type="text" id="location" name="location" class="form-input" value="{{ post.location or '' }}">
                </div>
                
                <div class="mb-6">
                    <label for="category">文章分类</label>
                    <select id="category" name="category" class="form-input">
                        <option value="" {% if not post.category %}selected{% endif %}>-- 选择分类 --</option>
                        <option value="游记攻略" {% if post.category == "游记攻略" %}selected{% endif %}>游记攻略</option>
                        <option value="美食推荐" {% if post.category == "美食推荐" %}selected{% endif %}>美食推荐</option>
                        <option value="景点介绍" {% if post.category == "景点介绍" %}selected{% endif %}>景点介绍</option>
                        <option value="文化体验" {% if post.category == "文化体验" %}selected{% endif %}>文化体验</option>
                        <option value="住宿推荐" {% if post.category == "住宿推荐" %}selected{% endif %}>住宿推荐</option>
                        <option value="交通指南" {% if post.category == "交通指南" %}selected{% endif %}>交通指南</option>
                        <option value="购物指南" {% if post.category == "购物指南" %}selected{% endif %}>购物指南</option>
                        <option value="旅行技巧" {% if post.category == "旅行技巧" %}selected{% endif %}>旅行技巧</option>
                        <option value="其他" {% if post.category == "其他" %}selected{% endif %}>其他</option>
                    </select>
                </div>
                
                <div class="mb-6">
                    <label for="destination_type">目的地类型</label>
                    <select id="destination_type" name="destination_type" class="form-input">
                        <option value="" {% if not post.destination_type %}selected{% endif %}>-- 选择目的地类型 --</option>
                        <option value="海滨度假" {% if post.destination_type == "海滨度假" %}selected{% endif %}>海滨度假</option>
                        <option value="山区自然" {% if post.destination_type == "山区自然" %}selected{% endif %}>山区自然</option>
                        <option value="历史古迹" {% if post.destination_type == "历史古迹" %}selected{% endif %}>历史古迹</option>
                        <option value="都市观光" {% if post.destination_type == "都市观光" %}selected{% endif %}>都市观光</option>
                        <option value="乡村田园" {% if post.destination_type == "乡村田园" %}selected{% endif %}>乡村田园</option>
                        <option value="主题公园" {% if post.destination_type == "主题公园" %}selected{% endif %}>主题公园</option>
                        <option value="文化遗产" {% if post.destination_type == "文化遗产" %}selected{% endif %}>文化遗产</option>
                        <option value="自然保护区" {% if post.destination_type == "自然保护区" %}selected{% endif %}>自然保护区</option>
                        <option value="其他" {% if post.destination_type == "其他" %}selected{% endif %}>其他</option>
                    </select>
                </div>
                
                <div class="mb-6">
                    <label for="rating">评分 (0-5分)</label>
                    <input type="number" id="rating" name="rating" class="form-input" value="{{ post.rating or 0.0 }}" min="0" max="5" step="0.1">
                </div>
                
                <div class="mb-6">
                    <label for="featured_image">特色图片</label>
                    {% if post.featured_image %}
                    <div class="mb-2">
                        <img src="{{ url_for('static', filename='uploads/posts/' + post.featured_image) }}" alt="当前图片" class="h-40 object-cover rounded mb-2">
                        <p class="text-sm text-gray-500">当前图片</p>
                    </div>
                    {% endif %}
                    <input type="file" id="featured_image" name="featured_image" class="form-input" accept="image/*">
                    <p class="text-sm text-gray-500">上传新图片将替换当前图片</p>
                </div>
                
                {# 附加图片 #}
                <div class="mb-6">
                    <label for="images">附加照片 (可多选)</label>
                    {% if post.images.count() > 0 %}
                    <div class="grid grid-cols-3 md:grid-cols-4 gap-4 mb-4">
                        {% for img in post.images %}
                        <img src="{{ url_for('static', filename='uploads/posts/' + img.filename) }}" alt="附图" class="w-full h-20 object-cover rounded shadow-sm">
                        {% endfor %}
                    </div>
                    {% endif %}
                    <input type="file" id="images" name="images" multiple accept="image/*" class="form-input">
                    <div id="preview" class="grid grid-cols-3 gap-4 mt-4"></div>
                </div>
                
                <div class="mb-6">
                    <label for="content">内容</label>
                    <!-- 直接使用textarea作为编辑器 -->
                    <textarea id="content" name="content" class="form-input" style="min-height:400px;">{{ post.content|safe }}</textarea>
                </div>
                
                <div class="checkbox-container">
                    <input type="checkbox" id="is_approved" name="is_approved" {% if post.is_approved %}checked{% endif %}>
                    <label for="is_approved" class="m-0">审核通过（勾选后将公开显示）</label>
                </div>
                
                <div class="flex justify-end gap-4">
                    <a href="{{ url_for('admin.manage_posts') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left mr-2"></i>返回
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save mr-2"></i>保存修改
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // 表单提交前验证
    document.querySelector('form').addEventListener('submit', function(e) {
        var title = document.getElementById('title').value.trim();
        if (!title) {
            e.preventDefault();
            alert('请输入帖子标题');
            return false;
        }
        
        var content = document.getElementById('content').value.trim();
        if (!content) {
            e.preventDefault();
            alert('请输入帖子内容');
            return false;
        }
    });

    const imgInput=document.getElementById('images');
    if(imgInput){
        imgInput.addEventListener('change',function(){
            const preview=document.getElementById('preview');
            preview.innerHTML='';
            Array.from(this.files).forEach(file=>{
                if(!file.type.startsWith('image/')) return;
                const reader=new FileReader();
                reader.onload=e=>{
                    const img=document.createElement('img');
                    img.src=e.target.result;
                    img.className='w-full h-20 object-cover rounded';
                    preview.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        });
    }
</script>
{% endblock %} 